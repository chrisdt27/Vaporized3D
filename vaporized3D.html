<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Vaporized ‚Äî Intro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- WebXR Required Meta Tags -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Preload critical assets -->
<link rel="preload" href="assets/audio/intro.mp3" as="audio">
<link rel="preload" href="assets/audio/reward_cheer.mp3" as="audio">
<link rel="preload" href="assets/audio/sad_crowd.mp3" as="audio">
<link rel="preload" href="assets/00_intro_1080p24.mp4" as="video">
<link rel="preload" href="assets/01_parking_offer_1080p24.mp4" as="video">
<style>
  /* [ALL YOUR EXISTING CSS STYLES - KEEP EXACTLY THE SAME] */
  :root {
    --bg:#000; --fg:#fff; --muted:#bbb;
    --accent:#23c2ff; --warn:#6a2c2c; --card:#111; --border:#333;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial;overflow:hidden}
  /* ... keep all your existing CSS exactly as it was ... */
</style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div>Loading Vaporized Experience...</div>
  </div>

  <!-- VR Mode Toggle -->
  <button id="vrToggle">Enter VR</button>

  <!-- VR Experience Button - ONLY CHANGE THIS LINE -->
  <div id="vrExperience" class="vr-section">
    <a href="journeys/mouth_Oculus.html" class="vr-launch-btn" id="vrLaunch">
      <span class="vr-icon">üëÅÔ∏è</span>
      Enter VR Experience
    </a>
  </div>

  <!-- Audio Elements - KEEP EXACTLY THE SAME -->
  <audio id="introMusic" src="assets/audio/intro.mp3" preload="auto" autoplay loop></audio>
  <audio id="cheeringCrowd" src="assets/audio/reward_cheer.mp3" preload="auto"></audio>
  <audio id="sadCrowd" src="assets/audio/sad_crowd.mp3" preload="auto"></audio>

  <!-- Star Wars Intro - KEEP EXACTLY THE SAME -->
  <div id="starwars-intro">
    <div class="stars" id="stars"></div>
    <div class="crawl" id="crawl">
      <h1 class="title">VAPORIZED</h1>
      <h2 class="subtitle">A Vape Breakers Production</h2>
      <div class="text-content">
        <p>In a world where vaping has become an epidemic among youth, one choice can change everything...</p>
        <p>What begins as a simple puff sets off an incredible journey through the human body, revealing the hidden dangers that lurk within every vapor cloud.</p>
        <p>From the mouth to the lungs, from the bloodstream to the brain - witness the path of destruction that unfolds with each inhalation.</p>
        <p>This is not just a story about vaping. This is a journey into the consequences of a single decision.</p>
        <p>The choice is yours. The journey awaits...</p>
      </div>
    </div>
    <div class="fade"></div>
    <button id="skipIntro">Skip Intro</button>
  </div>

  <div id="stage">
    <video id="vid" playsinline preload="auto" muted></video>
  </div>

  <!-- Choice UI - KEEP EXACTLY THE SAME -->
  <div id="choice">
    <div class="card">
      <h2>Take a Puff</h2>
      <button id="btnVR" class="btn btn-primary">Take a Puff</button>
    </div>
    <div class="card">
      <h2>No, Thanks</h2>
      <button id="btnNo" class="btn btn-warn">No, Thanks</button>
    </div>
  </div>

  <!-- Consequence Overlays - KEEP EXACTLY THE SAME -->
  <div id="negativeConsequence" class="consequence-overlay">
    <div class="consequence-card">
      <h2>Immediate Impact</h2>
      <p>Within seconds of inhaling, nicotine enters your bloodstream, increasing your heart rate and blood pressure. Your brain's reward system is activated, creating a craving for more.</p>
      <p>This is just the beginning of the harmful effects vaping has on your body.</p>
      <button id="negativeContinue" class="consequence-btn negative-btn">See How This Affects Your Body</button>
    </div>
  </div>

  <div id="positiveConsequence" class="consequence-overlay">
    <div class="consequence-card">
      <h2>Smart Choice!</h2>
      <p>By saying no to vaping, you've avoided immediate exposure to harmful chemicals like nicotine, formaldehyde, and acrolein that damage your lungs and cardiovascular system.</p>
      <p>Your body thanks you for this healthy decision.</p>
      <button id="positiveContinue" class="consequence-btn positive-btn">See What You Avoided</button>
    </div>
  </div>

  <!-- Continue to Classroom Button - KEEP EXACTLY THE SAME -->
  <button id="continueBtn" onclick="goToClassroom()">Continue to Classroom</button>

  <!-- Fade overlay - KEEP EXACTLY THE SAME -->
  <div id="fade" class="hidden"></div>
  <div id="err"></div>

<script>
  // -------- ONLY CHANGE THESE TWO LINES ----------
  const INTRO      = 'assets/00_intro_1080p24.mp4';      // KEEP THIS AS IT WAS WORKING
  const PARKING    = 'assets/01_parking_offer_1080p24.mp4'; // KEEP THIS AS IT WAS WORKING
  const TO_VR      = 'journeys/mouth_Oculus.html';        // ONLY CHANGE: mouth_final.html ‚Üí mouth_Oculus.html
  const TO_CLASSROOM = '../vape_on_the_brain_vr/Classroom/classroom_scene.html';

  // -------- DOM - KEEP EXACTLY THE SAME ----------
  const vid     = document.getElementById('vid');
  const choice  = document.getElementById('choice');
  const fadeEl  = document.getElementById('fade');
  const errEl   = document.getElementById('err');
  const btnVR   = document.getElementById('btnVR');
  const btnNo   = document.getElementById('btnNo');
  const continueBtn = document.getElementById('continueBtn');
  const starwarsIntro = document.getElementById('starwars-intro');
  const crawl = document.getElementById('crawl');
  const skipIntro = document.getElementById('skipIntro');
  const stars = document.getElementById('stars');
  const introMusic = document.getElementById('introMusic');
  const cheeringCrowd = document.getElementById('cheeringCrowd');
  const sadCrowd = document.getElementById('sadCrowd');
  const loading = document.getElementById('loading');
  const vrToggle = document.getElementById('vrToggle');
  const vrExperience = document.getElementById('vrExperience');
  const vrLaunch = document.getElementById('vrLaunch');
  const negativeConsequence = document.getElementById('negativeConsequence');
  const positiveConsequence = document.getElementById('positiveConsequence');
  const negativeContinue = document.getElementById('negativeContinue');
  const positiveContinue = document.getElementById('positiveContinue');

  // -------- WebXR/VR State - KEEP EXACTLY THE SAME ----------
  let xrSession = null;
  let isVRMode = false;
  let cheeringAudioPlayed = false;
  let sadAudioPlayed = false;

  // -------- Utils - KEEP EXACTLY THE SAME ----------
  function showError(msg){ console.error(msg); errEl.textContent = msg; errEl.style.display='block'; }
  
  function fadeAndGo(url){ 
    fadeEl.classList.remove('hidden');
    setTimeout(() => {
      try { 
        location.href = url; 
      } catch { 
        window.location = url;
      }
    }, 600); 
  }
  
  function showChoice(){ 
    choice.style.display='flex'; 
    btnVR?.focus(); 
  }
  
  function hideLoading() {
    loading.style.display = 'none';
    fadeEl.classList.add('hidden');
  }

  function goToClassroom() {
    fadeAndGo(TO_CLASSROOM);
  }

  function showContinueButton() {
    continueBtn.style.display = 'block';
  }

  // -------- VR EXPERIENCE LINKING - KEEP EXACTLY THE SAME ----------
  function showVRExperienceButton() {
    vrExperience.style.display = 'block';
  }

  function updateVRExperienceLink(choiceType) {
    // Update the VR experience link based on user choice
    let vrUrl = TO_VR;
    
    if (choiceType === 'positive') {
      vrUrl += '?choice=positive';
    } else if (choiceType === 'negative') {
      vrUrl += '?choice=negative';
    }
    
    vrLaunch.href = vrUrl;
    showVRExperienceButton();
  }

  // -------- AUDIO SYSTEM - KEEP EXACTLY THE SAME ----------
  function initializeAudio() {
    console.log("üéµ Initializing audio system...");
    
    // Set up both audio elements
    cheeringCrowd.volume = 0.8;
    sadCrowd.volume = 0.8;
    
    // Preload both audio files
    cheeringCrowd.load();
    sadCrowd.load();
    
    // Force intro music to play
    forceIntroMusicPlayback();
  }

  function forceIntroMusicPlayback() {
    console.log("üîä Forcing intro music playback...");
    
    introMusic.volume = 0.7;
    
    const playIntro = () => {
      introMusic.play().then(() => {
        console.log("‚úÖ Intro music playing automatically");
      }).catch(e => {
        console.log("‚ùå Autoplay blocked, using fallback...");
        createSilentInteraction();
      });
    };
    
    setTimeout(playIntro, 100);
  }

  function createSilentInteraction() {
    const silentButton = document.createElement('button');
    silentButton.style.cssText = 'position:absolute;opacity:0;width:1px;height:1px;z-index:-1;';
    silentButton.textContent = 'silent';
    document.body.appendChild(silentButton);
    
    setTimeout(() => {
      silentButton.click();
      console.log("üîÑ Silent interaction triggered");
      
      setTimeout(() => {
        introMusic.play().then(() => {
          console.log("‚úÖ Intro music playing after silent interaction");
        }).catch(e => {
          console.log("‚ùå Final audio failure, continuing without sound");
        });
      }, 100);
      
      setTimeout(() => {
        document.body.removeChild(silentButton);
      }, 1000);
    }, 500);
  }

  // Play cheering crowd audio for positive choice
  function playCheeringCrowd() {
    if (cheeringAudioPlayed) return;
    
    console.log("üéâ Playing reward_cheer.mp3...");
    
    cheeringCrowd.currentTime = 0;
    cheeringCrowd.volume = 0.8;
    
    const playAttempt = cheeringCrowd.play();
    
    if (playAttempt !== undefined) {
      playAttempt.then(() => {
        console.log("‚úÖ Cheering audio playing successfully!");
        cheeringAudioPlayed = true;
      }).catch(error => {
        console.log("‚ùå Cheering audio blocked, will play on next interaction");
        
        const enableAudio = () => {
          console.log("üñ±Ô∏è User interaction detected, playing cheering audio");
          cheeringCrowd.play().then(() => {
            console.log("‚úÖ Cheering audio playing after interaction!");
            cheeringAudioPlayed = true;
          }).catch(e => {
            console.log("‚ùå Final cheering audio failure");
          });
          document.removeEventListener('click', enableAudio);
        };
        
        document.addEventListener('click', enableAudio, { once: true });
      });
    }
  }

  // Play sad crowd audio for negative choice
  function playSadCrowd() {
    if (sadAudioPlayed) return;
    
    console.log("üò¢ Playing sad_crowd.mp3...");
    
    sadCrowd.currentTime = 0;
    sadCrowd.volume = 0.8;
    
    const playAttempt = sadCrowd.play();
    
    if (playAttempt !== undefined) {
      playAttempt.then(() => {
        console.log("‚úÖ Sad crowd audio playing successfully!");
        sadAudioPlayed = true;
      }).catch(error => {
        console.log("‚ùå Sad audio blocked, will play on next interaction");
        
        const enableAudio = () => {
          console.log("üñ±Ô∏è User interaction detected, playing sad audio");
          sadCrowd.play().then(() => {
            console.log("‚úÖ Sad crowd audio playing after interaction!");
            sadAudioPlayed = true;
          }).catch(e => {
            console.log("‚ùå Final sad audio failure");
          });
          document.removeEventListener('click', enableAudio);
        };
        
        document.addEventListener('click', enableAudio, { once: true });
      });
    }
  }

  // Show consequence overlay based on choice
  function showConsequence(isNegative) {
    if (isNegative) {
      negativeConsequence.style.display = 'flex';
      // Update VR link for negative choice
      updateVRExperienceLink('negative');
      // Play sad crowd for negative choice
      setTimeout(playSadCrowd, 300);
    } else {
      positiveConsequence.style.display = 'flex';
      // Update VR link for positive choice
      updateVRExperienceLink('positive');
      // Play cheering crowd for positive choice
      setTimeout(playCheeringCrowd, 300);
    }
  }

  // Hide all consequence overlays
  function hideConsequences() {
    negativeConsequence.style.display = 'none';
    positiveConsequence.style.display = 'none';
    cheeringCrowd.pause();
    cheeringCrowd.currentTime = 0;
    sadCrowd.pause();
    sadCrowd.currentTime = 0;
    cheeringAudioPlayed = false;
    sadAudioPlayed = false;
  }

  // Create starfield for Star Wars intro
  function createStarfield() {
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.width = Math.random() * 3 + 'px';
      star.style.height = star.style.width;
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.opacity = Math.random() * 0.7 + 0.3;
      stars.appendChild(star);
    }
  }

  // Check for WebXR support and initialize VR toggle
  async function checkXRSupport() {
    if (navigator.xr) {
      try {
        const supported = await navigator.xr.isSessionSupported('immersive-vr');
        if (supported) {
          vrToggle.style.display = 'block';
          return true;
        }
      } catch (e) {
        console.warn('WebXR not supported:', e);
      }
    }
    return false;
  }

  // Enter VR mode
  async function enterVR() {
    if (!navigator.xr) {
      showError('WebXR not supported in this browser');
      return;
    }

    try {
      xrSession = await navigator.xr.requestSession('immersive-vr', {
        optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking']
      });
      
      isVRMode = true;
      vrToggle.textContent = 'Exit VR';
      xrSession.addEventListener('end', onXRSessionEnded);
      showError('VR Mode Active - Full implementation requires WebGL rendering');
      
    } catch (e) {
      showError('Failed to enter VR: ' + e.message);
    }
  }

  // Exit VR mode
  function exitVR() {
    if (xrSession) {
      xrSession.end();
    }
  }

  // Handle XR session end
  function onXRSessionEnded() {
    xrSession = null;
    isVRMode = false;
    vrToggle.textContent = 'Enter VR';
    hideLoading();
  }

  // Play Star Wars intro
  function playStarWarsIntro() {
    return new Promise((resolve) => {
      const skipHandler = () => {
        fadeEl.classList.remove('hidden');
        setTimeout(() => {
          starwarsIntro.style.display = 'none';
          introMusic.pause();
          fadeEl.classList.add('hidden');
          resolve();
        }, 300);
      };
      
      skipIntro.addEventListener('click', skipHandler, { once: true });
      
      setTimeout(() => {
        if (starwarsIntro.style.display !== 'none') {
          skipHandler();
        }
      }, 30000);
    });
  }

  // Play a src and resolve when it ends; guard timer for bad metadata
  function playUntilEnd(src){
    return new Promise((resolve, reject)=>{
      let guard=null, ended=false;

      vid.src = src;
      vid.loop = false;
      vid.onerror = ()=>reject(new Error('Video failed to load: ' + src));

      const start = ()=>{
        const dur = Number.isFinite(vid.duration) && vid.duration>0 ? vid.duration : 75;
        guard = setTimeout(()=>{ if(!ended){ cleanup(); resolve(); } }, (dur+2)*1000);

        vid.play()
          .then(()=>{ vid.onended = ()=>{ ended=true; cleanup(); resolve(); }; })
          .catch(err=>{ cleanup(); reject(err); });
      };

      const cleanup = ()=>{ clearTimeout(guard); vid.onended=null; vid.oncanplay=null; vid.onloadedmetadata=null; };
      vid.onloadedmetadata = start;
      vid.oncanplay = start;
      vid.load();
    });
  }

  async function startSequenceWithAudio(){
    vid.muted = false;
    await playStarWarsIntro();
    await playUntilEnd(INTRO);
    await playUntilEnd(PARKING);
    showChoice();
  }

  // Initialize the application
  async function init() {
    try {
      initializeAudio();
      await checkXRSupport();
      createStarfield();
      setTimeout(hideLoading, 1000);
      await startSequenceWithAudio();
    } catch(e) {
      showError(e.message || String(e));
      hideLoading();
      showChoice();
    }
  }

  // Initialize when page loads
  window.addEventListener('load', init);

  // Event Listeners - KEEP EXACTLY THE SAME
  btnVR.addEventListener('click',  ()=> {
    showConsequence(true);
  });
  
  btnNo.addEventListener('click',  ()=> {
    showConsequence(false);
  });

  negativeContinue.addEventListener('click', () => {
    hideConsequences();
    fadeAndGo(TO_VR);
    setTimeout(showContinueButton, 45000);
  });

  positiveContinue.addEventListener('click', () => {
    hideConsequences();
    fadeAndGo(TO_VR);
    setTimeout(showContinueButton, 45000);
  });

  // VR Toggle
  vrToggle.addEventListener('click', () => {
    if (isVRMode) {
      exitVR();
    } else {
      enterVR();
    }
  });

  // VR Experience Button
  vrLaunch.addEventListener('click', (e) => {
    e.preventDefault();
    console.log('Launching VR experience with choice parameter');
    fadeAndGo(vrLaunch.href);
  });

  // Keyboard shortcuts - KEEP EXACTLY THE SAME
  window.addEventListener('keydown', (e)=>{
    if(e.key==='1') {
      showConsequence(true);
    }
    if(e.key==='2') {
      showConsequence(false);
    }
    if(e.key==='3') goToClassroom();
    if(e.key==='Escape' && starwarsIntro.style.display === 'block') {
      starwarsIntro.style.display = 'none';
      introMusic.pause();
    }
    if(e.key === 'v' || e.key === 'V') {
      if (vrToggle.style.display !== 'none') {
        if (isVRMode) {
          exitVR();
        } else {
          enterVR();
        }
      }
    }
    if(e.key === 'r' || e.key === 'R') {
      // Quick access to VR experience
      if (vrExperience.style.display !== 'none') {
        vrLaunch.click();
      }
    }
  });

  // Auto-detect if we're returning from body journey and show continue button
  window.addEventListener('pageshow', function(event) {
    if (sessionStorage.getItem('bodyJourneyCompleted')) {
      showContinueButton();
      sessionStorage.removeItem('bodyJourneyCompleted');
    }
  });

  // Handle device orientation for mobile VR
  window.addEventListener('deviceorientation', function(e) {
    if (isVRMode) {
      console.log('Device orientation:', e.alpha, e.beta, e.gamma);
    }
  }, true);
</script>
</body>
</html>
