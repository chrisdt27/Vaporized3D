<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Vaporized ‚Äî Choice System</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- WebXR Required Meta Tags -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root {
    --bg:#000; --fg:#fff; --muted:#bbb;
    --accent:#23c2ff; --warn:#6a2c2c; --card:#111; --border:#333;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Arial;overflow:hidden}

  /* Stage */
  #stage{position:fixed;inset:0;display:grid;place-items:center}
  video{max-width:100vw;max-height:100vh;object-fit:cover;background:#000}

  /* Fade overlay - Always visible but transparent by default */
  #fade{pointer-events:none;position:fixed;inset:0;background:#000;opacity:1;transition:opacity .6s;z-index:10005}
  #fade.hidden{opacity:0}

  /* Choice screen ‚Äî VR-optimized for Oculus */
  #choice{position:fixed;inset:0;display:none;align-items:center;justify-content:center;gap:24px;background:rgba(0,0,0,.80);padding:20px;z-index:1000}
  .card{min-width:280px;max-width:420px;border-radius:14px;padding:18px 20px;background:var(--card);border:1px solid var(--border);box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .card h2{margin:0 0 .6em 0;font-size:26px}
  .btn{display:inline-block;padding:12px 18px;border-radius:10px;border:0;font-weight:800;cursor:pointer;transition:transform 0.2s, filter 0.2s}
  .btn:hover{transform:scale(1.05);filter:brightness(1.2)}
  .btn-primary{background:var(--accent);color:#002}
  .btn-warn{background:var(--warn);color:#fff}

  /* Error bar */
  #err{position:fixed;left:0;right:0;bottom:0;background:rgba(200,0,0,.75);padding:6px 10px;font-size:12px;display:none;white-space:pre-wrap;z-index:1001}

  /* Continue button for Classroom transition */
  #continueBtn {
    position: fixed;
    bottom: 40px;
    right: 40px;
    padding: 15px 30px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 16px;
    cursor: pointer;
    display: none;
    z-index: 1000;
    transition: transform 0.2s, filter 0.2s;
  }
  #continueBtn:hover {
    transform: scale(1.05);
    filter: brightness(1.2);
  }

  /* Consequence Overlay Styles - VR Optimized */
  .consequence-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.85);
    z-index: 1002;
    padding: 20px;
  }
  
  .consequence-card {
    max-width: 600px;
    width: 90%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 15px 30px rgba(0,0,0,0.5);
  }
  
  .consequence-card h2 {
    font-size: 32px;
    margin-bottom: 20px;
    color: var(--accent);
  }
  
  .consequence-card p {
    font-size: 18px;
    line-height: 1.6;
    margin-bottom: 30px;
    color: var(--fg);
  }
  
  .consequence-btn {
    padding: 15px 30px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: transform 0.2s, filter 0.2s;
  }
  
  .consequence-btn:hover {
    transform: scale(1.05);
    filter: brightness(1.2);
  }
  
  .negative-btn {
    background: #ff4d4d;
    color: white;
  }
  
  .positive-btn {
    background: #4CAF50;
    color: white;
  }

  /* VR Mode Toggle */
  #vrToggle {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0,0,0,0.7);
    color: var(--accent);
    border: 1px solid var(--accent);
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    z-index: 1003;
    font-family: system-ui;
    display: none;
  }
  
  #vrToggle:hover {
    background: rgba(35, 194, 255, 0.2);
  }

  /* VR Experience Section */
  .vr-section {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1004;
    display: none;
  }

  .vr-launch-btn {
    display: inline-block;
    padding: 12px 20px;
    background: var(--accent);
    color: #002;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(76, 201, 240, 0.4);
    border: none;
    cursor: pointer;
  }

  .vr-launch-btn:hover {
    background: #7bdff2;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(76, 201, 240, 0.6);
  }

  .vr-icon {
    margin-right: 8px;
    font-size: 1.2rem;
  }

  /* Star Wars Intro Styles - FIXED STRUCTURE */
  #starwars-intro {
    position: fixed;
    inset: 0;
    background: #000;
    color: #ffd700;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    perspective: 400px;
    display: block;
    z-index: 10000;
  }

  #starfield {
    position: absolute;
    width: 100%;
    height: 100%;
    background: #000;
  }

  .star {
    position: absolute;
    background: #fff;
    border-radius: 50%;
  }

  #intro-container {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    transform-style: preserve-3d;
    transform: rotateX(25deg);
    transform-origin: 50% 100%;
  }

  #crawl-content {
    position: absolute;
    width: 80%;
    text-align: center;
    color: #ffd700;
    text-shadow: 0 0 10px #ffd700;
    animation: crawl 30s linear forwards;
  }

  @keyframes crawl {
    0% {
      transform: translateY(100vh) rotateX(20deg);
      opacity: 1;
    }
    85% {
      opacity: 1;
    }
    100% {
      transform: translateY(-180vh) rotateX(20deg);
      opacity: 0;
    }
  }

  .title {
    font-size: 4vw;
    margin-bottom: 15vh;
    font-weight: bold;
  }

  .subtitle {
    font-size: 2.5vw;
    margin-bottom: 18vh;
    font-weight: bold;
  }

  .paragraph {
    font-size: 2.2vw;
    margin-bottom: 16vh;
    line-height: 1.6;
    text-align: left;
  }

  .emphasis {
    font-weight: bold;
    margin-top: 18vh;
    margin-bottom: 5vh;
  }

  /* Video containers - MOVED OUTSIDE starwars-intro */
  #video-container, #next-video-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    opacity: 0;
    visibility: hidden;
    z-index: 9999;
    transition: opacity 0.5s ease-in-out;
  }

  #next-video-container {
    z-index: 9998;
  }

  #intro-video, #next-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #video-container.active, #next-video-container.active {
    opacity: 1;
    visibility: visible;
  }

  /* Skip button for intro */
  #skipIntro {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.7);
    color: #ffd700;
    border: 1px solid #ffd700;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    z-index: 10001;
    font-family: system-ui;
    transition: background 0.2s;
  }

  #skipIntro:hover {
    background: rgba(255,215,0,0.2);
  }

  /* Loading indicator */
  #loading {
    position: fixed;
    inset: 0;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10004;
    flex-direction: column;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Scene progress indicator */
  #scene-progress {
    position: fixed;
    top: 20px;
    left: 20px;
    color: #ffd700;
    font-size: 1rem;
    z-index: 10001;
    background: rgba(0, 0, 0, 0.5);
    padding: 5px 10px;
    border-radius: 5px;
  }
</style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div>Loading Vaporized Experience...</div>
  </div>

  <!-- VR Mode Toggle -->
  <button id="vrToggle">Enter VR</button>

  <!-- VR Experience Button -->
  <div id="vrExperience" class="vr-section">
    <a href="journeys/mouth_Oculus.html" class="vr-launch-btn" id="vrLaunch">
      <span class="vr-icon">üëÅÔ∏è</span>
      Enter VR Experience
    </a>
  </div>

  <!-- Audio Elements -->
  <audio id="introMusic" src="assets/audio/intro.mp3" preload="auto"></audio>
  <audio id="cheeringCrowd" src="assets/audio/reward_cheer.mp3" preload="auto"></audio>
  <audio id="sadCrowd" src="assets/audio/sad_crowd.mp3" preload="auto"></audio>

  <!-- Star Wars Intro -->
  <div id="starwars-intro">
    <div id="starfield"></div>
    <div id="intro-container">
      <div id="crawl-content">
        <div class="title">VAPORIZED</div>
        <div class="subtitle">A Vape Breakers Production</div>
        
        <div class="paragraph">In a world where vaping has become an epidemic among youth, one choice can change everything...</div>
        
        <div class="paragraph">What begins as a simple puff sets off an incredible journey through the human body, revealing the hidden dangers that lurk within every vapor cloud.</div>
        
        <div class="paragraph">From the mouth to the lungs, from the bloodstream to the brain - witness the path of destruction that unfolds with each inhalation.</div>
        
        <div class="paragraph">This is not just a story about vaping. This is a journey into the consequences of a single decision.</div>
        
        <div class="paragraph emphasis">The choice is yours. The journey awaits...</div>
      </div>
    </div>
    
    <div id="scene-progress">Scene 1/3</div>
    <button id="skipIntro">Skip Intro</button>
  </div>

  <!-- Video Containers - SEPARATE from starwars-intro -->
  <div id="video-container">
    <video id="intro-video" preload="auto" muted playsinline>
      <source src="assets/00_intro_1080p24.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>
  
  <div id="next-video-container">
    <video id="next-video" preload="auto" muted playsinline>
      <source src="assets/01_parking_offer_1080p24.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- Main video stage (for fallback) -->
  <div id="stage" style="display:none;">
    <video id="vid" playsinline preload="auto" muted></video>
  </div>

  <!-- Choice UI -->
  <div id="choice">
    <div class="card">
      <h2>Take a Puff</h2>
      <button id="btnVR" class="btn btn-primary">Take a Puff</button>
    </div>
    <div class="card">
      <h2>No, Thanks</h2>
      <button id="btnNo" class="btn btn-warn">No, Thanks</button>
    </div>
  </div>

  <!-- Consequence Overlays -->
  <div id="negativeConsequence" class="consequence-overlay">
    <div class="consequence-card">
      <h2>Immediate Impact</h2>
      <p>Within seconds of inhaling, nicotine enters your bloodstream, increasing your heart rate and blood pressure. Your brain's reward system is activated, creating a craving for more.</p>
      <p>This is just the beginning of the harmful effects vaping has on your body.</p>
      <button id="negativeContinue" class="consequence-btn negative-btn">See How This Affects Your Body</button>
    </div>
  </div>

  <div id="positiveConsequence" class="consequence-overlay">
    <div class="consequence-card">
      <h2>Smart Choice!</h2>
      <p>By saying no to vaping, you've avoided immediate exposure to harmful chemicals like nicotine, formaldehyde, and acrolein that damage your lungs and cardiovascular system.</p>
      <p>Your body thanks you for this healthy decision.</p>
      <button id="positiveContinue" class="consequence-btn positive-btn">See What You Avoided</button>
    </div>
  </div>

  <!-- Continue to Classroom Button -->
  <button id="continueBtn" onclick="goToClassroom()">Continue to Classroom</button>

  <!-- Fade overlay -->
  <div id="fade" class="hidden"></div>
  <div id="err"></div>

<script>
  // -------- Paths ----------
  const INTRO      = 'assets/00_intro_1080p24.mp4';
  const PARKING    = 'assets/01_parking_offer_1080p24.mp4';
  const TO_VR      = 'journeys/mouth_Oculus.html';
  const TO_CLASSROOM = '../vape_on_the_brain_vr/Classroom/classroom_scene.html';

  // -------- DOM ----------
  const vid     = document.getElementById('vid');
  const choice  = document.getElementById('choice');
  const fadeEl  = document.getElementById('fade');
  const errEl   = document.getElementById('err');
  const btnVR   = document.getElementById('btnVR');
  const btnNo   = document.getElementById('btnNo');
  const continueBtn = document.getElementById('continueBtn');
  const starwarsIntro = document.getElementById('starwars-intro');
  const crawlContent = document.getElementById('crawl-content');
  const skipIntro = document.getElementById('skipIntro');
  const starfield = document.getElementById('starfield');
  const introMusic = document.getElementById('introMusic');
  const cheeringCrowd = document.getElementById('cheeringCrowd');
  const sadCrowd = document.getElementById('sadCrowd');
  const loading = document.getElementById('loading');
  const vrToggle = document.getElementById('vrToggle');
  const vrExperience = document.getElementById('vrExperience');
  const vrLaunch = document.getElementById('vrLaunch');
  const negativeConsequence = document.getElementById('negativeConsequence');
  const positiveConsequence = document.getElementById('positiveConsequence');
  const negativeContinue = document.getElementById('negativeContinue');
  const positiveContinue = document.getElementById('positiveContinue');
  
  // Video containers - NOW SEPARATE
  const videoContainer = document.getElementById('video-container');
  const introVideo = document.getElementById('intro-video');
  const nextVideoContainer = document.getElementById('next-video-container');
  const nextVideo = document.getElementById('next-video');
  const sceneProgress = document.getElementById('scene-progress');

  // -------- State ----------
  let xrSession = null;
  let isVRMode = false;
  let cheeringAudioPlayed = false;
  let sadAudioPlayed = false;
  let transitionTriggered = false;
  let musicPlaying = false;
  let audioInitialized = false;
  let videosPreloaded = false;

  // -------- Utils ----------
  function showError(msg){ console.error(msg); errEl.textContent = msg; errEl.style.display='block'; }
  
  function fadeAndGo(url){ 
    fadeEl.classList.remove('hidden');
    setTimeout(() => {
      try { 
        location.href = url; 
      } catch { 
        window.location = url;
      }
    }, 600); 
  }
  
  function showChoice(){ 
    choice.style.display='flex'; 
    btnVR?.focus(); 
  }
  
  function hideLoading() {
    loading.style.display = 'none';
    fadeEl.classList.add('hidden');
  }

  function goToClassroom() {
    fadeAndGo(TO_CLASSROOM);
  }

  function showContinueButton() {
    continueBtn.style.display = 'block';
  }

  // -------- Debug Functions ----------
  async function debugAssetPaths() {
    console.log('üîç DEBUG: Checking if assets exist...');
    const testAssets = [
      'assets/00_intro_1080p24.mp4',
      'assets/01_parking_offer_1080p24.mp4', 
      'assets/audio/intro.mp3',
      'assets/audio/reward_cheer.mp3',
      'assets/audio/sad_crowd.mp3',
      'journeys/mouth_Oculus.html'
    ];
    
    for (const asset of testAssets) {
      try {
        const response = await fetch(asset, { method: 'HEAD' });
        console.log(`${response.ok ? '‚úÖ' : '‚ùå'} ${asset}: ${response.status}`);
      } catch (error) {
        console.log(`‚ùå ${asset}: ${error.message}`);
      }
    }
  }

  // -------- VIDEO PRELOADING ----------
  function preloadVideos() {
    if (videosPreloaded) return;
    
    console.log('üìπ Preloading videos...');
    
    // Force videos to load by setting currentTime to 0 and loading
    introVideo.load();
    nextVideo.load();
    
    // Set up canplay event listeners
    introVideo.addEventListener('canplay', function() {
      console.log('‚úÖ Intro video ready to play');
    });
    
    nextVideo.addEventListener('canplay', function() {
      console.log('‚úÖ Next video ready to play');
    });
    
    // Set up error handling
    introVideo.addEventListener('error', function(e) {
      console.error('‚ùå Intro video error:', e);
    });
    
    nextVideo.addEventListener('error', function(e) {
      console.error('‚ùå Next video error:', e);
    });
    
    videosPreloaded = true;
  }

  // -------- VR EXPERIENCE LINKING ----------
  function showVRExperienceButton() {
    vrExperience.style.display = 'block';
  }

  function updateVRExperienceLink(choiceType) {
    let vrUrl = TO_VR;
    if (choiceType === 'positive') {
      vrUrl += '?choice=positive';
    } else if (choiceType === 'negative') {
      vrUrl += '?choice=negative';
    }
    vrLaunch.href = vrUrl;
    showVRExperienceButton();
  }

  // -------- STAR WARS INTRO - FIXED ----------
  function createStarfield() {
    for (let i = 0; i < 150; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.width = Math.random() * 2 + 'px';
      star.style.height = star.style.width;
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.opacity = Math.random() * 0.7 + 0.3;
      starfield.appendChild(star);
    }
  }
  
  function initializeAudio() {
    if (audioInitialized) return;
    audioInitialized = true;
    introMusic.volume = 0.7;
    
    // Don't try to play music automatically - it will block video autoplay
    console.log("üéµ Audio initialized (will play with videos)");
  }
  
  function stopIntroMusic() {
    if (musicPlaying) {
      console.log("üõë Stopping intro music");
      introMusic.pause();
      introMusic.currentTime = 0;
      musicPlaying = false;
    }
  }
  
  function playIntroMusic() {
    if (!musicPlaying) {
      introMusic.play().then(() => {
        musicPlaying = true;
        console.log("‚úÖ Intro music playing");
      }).catch(e => {
        console.log("‚ùå Music play failed:", e);
      });
    }
  }
  
  function transitionToIntroVideo() {
    if (!transitionTriggered) {
      transitionTriggered = true;
      console.log('Star Wars intro completed - transitioning to intro video');
      
      // Hide star wars intro
      starwarsIntro.style.display = 'none';
      
      // Show and play intro video
      videoContainer.style.opacity = '1';
      videoContainer.style.visibility = 'visible';
      sceneProgress.textContent = 'Scene 2/3';
      
      // Try to play the video immediately
      console.log('üé¨ Attempting to play intro video...');
      
      const playVideo = () => {
        introVideo.play().then(() => {
          console.log('‚úÖ Intro video playing successfully');
          playIntroMusic(); // Start music when video plays
          
          // Set up ended listener
          introVideo.addEventListener('ended', function onIntroEnded() {
            console.log('Intro video completed - transitioning to parking lot scene');
            introVideo.removeEventListener('ended', onIntroEnded);
            transitionToNextScene();
          }, { once: true });
          
        }).catch((error) => {
          console.log('‚ùå Intro video autoplay failed:', error);
          
          // Try one more time with a small delay
          setTimeout(() => {
            introVideo.play().then(() => {
              console.log('‚úÖ Intro video playing on second attempt');
              playIntroMusic();
              
              introVideo.addEventListener('ended', function onIntroEnded() {
                console.log('Intro video completed - transitioning to parking lot scene');
                introVideo.removeEventListener('ended', onIntroEnded);
                transitionToNextScene();
              }, { once: true });
              
            }).catch((error2) => {
              console.log('‚ùå Second attempt failed, auto-skipping to next scene:', error2);
              // Auto-skip to next scene if video can't play
              setTimeout(transitionToNextScene, 100);
            });
          }, 500);
        });
      };
      
      // Small delay to ensure video container is visible
      setTimeout(playVideo, 100);
    }
  }
  
  function transitionToNextScene() {
    console.log('Transitioning to parking lot scene');
    
    // Hide intro video
    videoContainer.style.opacity = '0';
    videoContainer.style.visibility = 'hidden';
    
    // Show and play next video
    nextVideoContainer.style.opacity = '1';
    nextVideoContainer.style.visibility = 'visible';
    sceneProgress.textContent = 'Scene 3/3';
    
    console.log('üé¨ Attempting to play next video...');
    
    const playNextVideo = () => {
      nextVideo.play().then(() => {
        console.log('‚úÖ Next video playing successfully');
        
        // Set up ended listener
        nextVideo.addEventListener('ended', function onNextEnded() {
          console.log('Parking lot scene completed - showing choice interface');
          nextVideo.removeEventListener('ended', onNextEnded);
          nextVideoContainer.style.opacity = '0';
          nextVideoContainer.style.visibility = 'hidden';
          sceneProgress.style.display = 'none';
          showChoice();
        }, { once: true });
        
      }).catch((error) => {
        console.log('‚ùå Next video autoplay failed:', error);
        
        // Try one more time with a small delay
        setTimeout(() => {
          nextVideo.play().then(() => {
            console.log('‚úÖ Next video playing on second attempt');
            
            nextVideo.addEventListener('ended', function onNextEnded() {
              console.log('Parking lot scene completed - showing choice interface');
              nextVideo.removeEventListener('ended', onNextEnded);
              nextVideoContainer.style.opacity = '0';
              nextVideoContainer.style.visibility = 'hidden';
              sceneProgress.style.display = 'none';
              showChoice();
            }, { once: true });
            
          }).catch((error2) => {
            console.log('‚ùå Second attempt failed, auto-skipping to choice:', error2);
            // Auto-skip to choice if video can't play
            nextVideoContainer.style.opacity = '0';
            nextVideoContainer.style.visibility = 'hidden';
            sceneProgress.style.display = 'none';
            showChoice();
          });
        }, 500);
      });
    };
    
    // Small delay to ensure video container is visible
    setTimeout(playNextVideo, 100);
  }

  // -------- AUDIO FEEDBACK ----------
  function playCheeringCrowd() {
    if (cheeringAudioPlayed) return;
    
    console.log("üéâ Playing reward_cheer.mp3...");
    cheeringCrowd.currentTime = 0;
    cheeringCrowd.volume = 0.8;
    
    cheeringCrowd.play().then(() => {
      console.log("‚úÖ Cheering audio playing successfully!");
      cheeringAudioPlayed = true;
    }).catch(error => {
      console.log("‚ùå Cheering audio blocked");
    });
  }

  function playSadCrowd() {
    if (sadAudioPlayed) return;
    
    console.log("üò¢ Playing sad_crowd.mp3...");
    sadCrowd.currentTime = 0;
    sadCrowd.volume = 0.8;
    
    sadCrowd.play().then(() => {
      console.log("‚úÖ Sad crowd audio playing successfully!");
      sadAudioPlayed = true;
    }).catch(error => {
      console.log("‚ùå Sad audio blocked");
    });
  }

  function showConsequence(isNegative) {
    if (isNegative) {
      negativeConsequence.style.display = 'flex';
      updateVRExperienceLink('negative');
      setTimeout(playSadCrowd, 300);
    } else {
      positiveConsequence.style.display = 'flex';
      updateVRExperienceLink('positive');
      setTimeout(playCheeringCrowd, 300);
    }
  }

  function hideConsequences() {
    negativeConsequence.style.display = 'none';
    positiveConsequence.style.display = 'none';
    cheeringCrowd.pause();
    cheeringCrowd.currentTime = 0;
    sadCrowd.pause();
    sadCrowd.currentTime = 0;
    cheeringAudioPlayed = false;
    sadAudioPlayed = false;
  }

  // -------- VR SUPPORT ----------
  async function checkXRSupport() {
    if (navigator.xr) {
      try {
        const supported = await navigator.xr.isSessionSupported('immersive-vr');
        if (supported) {
          vrToggle.style.display = 'block';
          return true;
        }
      } catch (e) {
        console.warn('WebXR not supported:', e);
      }
    }
    return false;
  }

  async function enterVR() {
    if (!navigator.xr) {
      showError('WebXR not supported in this browser');
      return;
    }

    try {
      xrSession = await navigator.xr.requestSession('immersive-vr', {
        optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking']
      });
      
      isVRMode = true;
      vrToggle.textContent = 'Exit VR';
      xrSession.addEventListener('end', onXRSessionEnded);
      showError('VR Mode Active - Full implementation requires WebGL rendering');
      
    } catch (e) {
      showError('Failed to enter VR: ' + e.message);
    }
  }

  function exitVR() {
    if (xrSession) {
      xrSession.end();
    }
  }

  function onXRSessionEnded() {
    xrSession = null;
    isVRMode = false;
    vrToggle.textContent = 'Enter VR';
  }

  // -------- INITIALIZATION ----------
  async function init() {
    try {
      // DEBUG: Check if assets are accessible
      await debugAssetPaths();
      
      // Preload videos during the Star Wars intro
      preloadVideos();
      
      // Initialize the working Star Wars intro
      createStarfield();
      initializeAudio();
      
      // Set up crawl completion handler
      crawlContent.addEventListener('animationend', function() {
        console.log('Crawl animation ended - transitioning to video');
        transitionToIntroVideo();
      });
      
      // Set up skip button
      skipIntro.addEventListener('click', function() {
        console.log('Skip button clicked - transitioning to video');
        crawlContent.style.animation = 'none';
        transitionToIntroVideo();
      });
      
      // Check for VR support
      await checkXRSupport();
      
      // Hide loading screen
      setTimeout(hideLoading, 1000);
      
      console.log('Star Wars intro started - 30 seconds scrolling text');
      
    } catch(e) {
      showError(e.message || String(e));
      hideLoading();
      starwarsIntro.style.display = 'none';
      showChoice();
    }
  }

  // -------- EVENT LISTENERS ----------
  window.addEventListener('load', init);

  btnVR.addEventListener('click',  ()=> {
    showConsequence(true);
  });
  
  btnNo.addEventListener('click',  ()=> {
    showConsequence(false);
  });

  negativeContinue.addEventListener('click', () => {
    hideConsequences();
    fadeAndGo(TO_VR);
    setTimeout(showContinueButton, 45000);
  });

  positiveContinue.addEventListener('click', () => {
    hideConsequences();
    fadeAndGo(TO_VR);
    setTimeout(showContinueButton, 45000);
  });

  vrToggle.addEventListener('click', () => {
    if (isVRMode) {
      exitVR();
    } else {
      enterVR();
    }
  });

  vrLaunch.addEventListener('click', (e) => {
    e.preventDefault();
    console.log('Launching VR experience with choice parameter');
    fadeAndGo(vrLaunch.href);
  });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key==='1') showConsequence(true);
    if(e.key==='2') showConsequence(false);
    if(e.key==='3') goToClassroom();
    if(e.key==='Escape' && starwarsIntro.style.display === 'block') {
      console.log('Escape pressed - stopping music and showing choice');
      stopIntroMusic();
      starwarsIntro.style.display = 'none';
      showChoice();
    }
    if(e.key === ' ' && !transitionTriggered) {
      console.log('Space pressed - skipping to video');
      crawlContent.style.animation = 'none';
      transitionToIntroVideo();
    }
    if(e.key === 'v' || e.key === 'V') {
      if (vrToggle.style.display !== 'none') {
        if (isVRMode) exitVR();
        else enterVR();
      }
    }
    if(e.key === 'r' || e.key === 'R') {
      if (vrExperience.style.display !== 'none') {
        vrLaunch.click();
      }
    }
  });

  window.addEventListener('pageshow', function(event) {
    if (sessionStorage.getItem('bodyJourneyCompleted')) {
      showContinueButton();
      sessionStorage.removeItem('bodyJourneyCompleted');
    }
  });

  window.addEventListener('deviceorientation', function(e) {
    if (isVRMode) {
      console.log('Device orientation:', e.alpha, e.beta, e.gamma);
    }
  }, true);
</script>
</body>
</html>
